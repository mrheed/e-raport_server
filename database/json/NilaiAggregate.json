[
    {"$lookup": {
        "from": "c_kompetensi_dasar",
        "localField": "materi",
        "foreignField": "kode_materi",
        "as": "materi"
    }},
    {"$unwind": "$materi"},
    {
        "$lookup": {
            "from": "c_mapel",
            "localField": "mapel",
            "foreignField": "kode_mapel",
            "as": "tmapel"
        }
    },
    {"$unwind": "$tmapel"},
    {
        "$group": {
            "_id": {
                "nis": "$nis",
                "day": {"$month": "$tanggal_ulangan"},
                "mapel": "$tmapel.nama_mapel"
            },
            "f": {"$push": {
                "tanggal_ulangan": "$tanggal_ulangan",
                "materi": "$materi.nama_materi",
                "kkm": "$kkm",
                "nilai_remidi": "$nilai_remidi",
                "nilai_ulangan": "$nilai_ulangan"
            }},
            "jr": {"$push": {"$cond": ["$remidi", 1, 0]}},
            "ju": {"$sum": 1},
            "avg": {"$avg": "$nilai_ulangan"}  
        }
    },
    {"$sort": {"f.tanggal_ulangan": 1}},
    {
        "$project": {
            "_id": 1,
            "f": 1,
            "jr": 1,
            "ju": 1,
            "avg": {"$divide":[
                {"$subtract":[
                     {"$multiply":["$avg",100]},
                     {"$mod":[{"$multiply":["$avg",100]}, 1]}
                ]},
                100
           ]}
        }
    },
    {
        "$group": {
            "_id": {
                "mapel": "$_id.mapel",
                "nis": "$_id.nis"
            },
            "avg_data": {"$push": {
                "month": "$_id.day",
                "jumlah_remidi": {"$sum": "$jr"},
                "avg": "$avg",
                "date": "$f.tanggal_ulangan",
                "jumlah_ulangan": "$ju"
            }},
            "avg": {"$avg": {
                "$divide": [{"$trunc": {"$multiply": ["$avg", 100]}}, 100]
            }},
            "urai_data": {"$push": {
                "data": "$f",
                "bulan": "$_id.day",
                "date": "$f.tanggal_ulangan"
            }}
        }
    },
    {"$sort": {"_id.mapel": 1}},
    {
        "$group": {
            "_id": "$_id.nis",
            "avg": {"$push": {
                "Rata-rata": "$avg",
                "mapel": "$_id.mapel"
            }},
            "data_mapel": {"$push": {
                "mapel": "$_id.mapel",
                "avg_data": "$avg_data",
                "urai_data": "$urai_data"
            }}
        }
    }
]